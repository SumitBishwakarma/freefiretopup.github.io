<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expandable Tracker App (Full Width)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* --- Inside the <style> tag --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        /* --- Color Palette --- */
        :root {
            --primary-color: #6d28d9; --primary-light: #c4b5fd; --primary-lighter: #ede9fe; --primary-bg: #f5f3ff; --text-dark: #111827; --text-medium: #4b5563; --text-light: #f9fafb; --border-color: #e5e7eb; --border-stronger: #d1d5db; --container-bg: #ffffff; --hover-bg: var(--primary-lighter); --header-bg-month: #f9fafb; --header-bg-name: var(--primary-lighter); --icon-color: #9ca3af; --icon-hover-color: var(--primary-color);
            --btn-action-bg: var(--primary-color); --btn-action-hover-bg: #5b21b6; --btn-img-bg: #10b981; --btn-img-hover-bg: #059669; --btn-delete-bg: #ef4444; --btn-delete-hover-bg: #dc2626; --btn-disabled-bg: #e5e7eb;
        }

        /* --- Base & Layout --- */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 15px; /* Minimal body padding */
            background-color: var(--primary-bg);
            color: var(--text-dark);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .tracker-container {
            width: 100%;
            /* Removed fixed max-width, using viewport width instead */
            max-width: 96vw; /* Takes up 96% of the screen width */
            background-color: var(--container-bg);
            padding: 25px 30px;
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(109, 40, 217, 0.08), 0 4px 8px rgba(109, 40, 217, 0.06);
        }
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; position: relative; }
        h1.tracker-title { text-align: center; color: var(--primary-color); margin: 0 auto; padding: 0 40px; font-size: 24px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .settings-icon { position: absolute; right: 0px; top: 50%; transform: translateY(-50%); font-size: 24px; color: var(--icon-color); cursor: pointer; transition: color 0.3s ease, transform 0.3s ease; padding: 4px; flex-shrink: 0; line-height: 1; }
        .settings-icon:hover { color: var(--icon-hover-color); transform: translateY(-50%) rotate(45deg); }
        .settings-icon.active { transform: translateY(-50%) rotate(90deg); color: var(--icon-hover-color); }

        /* --- Settings Menu --- */
        .settings-menu { margin-bottom: 20px; padding: 15px; border: 1px solid var(--border-color); background-color: #fdfdff; border-radius: 10px; display: flex; flex-direction: column; gap: 15px; max-height: 0; overflow: hidden; opacity: 0; transition: max-height 0.4s ease-out, opacity 0.3s ease-in-out, padding 0.4s ease-out, margin-bottom 0.4s ease-out; }
        .settings-menu.open { max-height: 500px; opacity: 1; padding: 15px; margin-bottom: 20px; }
        .tracker-select-group { display: flex; align-items: center; gap: 8px; width: 100%; }
        .tracker-select-group label { font-weight: 600; color: var(--text-medium); white-space: nowrap; font-size: 13px; }
        .tracker-select-group select { padding: 8px 10px; border: 1px solid var(--border-stronger); border-radius: 6px; font-family: inherit; font-size: 13px; flex-grow: 1; min-width: 140px; cursor: pointer; background-color: #fff; }
        .action-buttons { display: flex; flex-wrap: wrap; gap: 8px; width: 100%; justify-content: center; }
        .settings-menu .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s ease; color: var(--text-light); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .settings-menu .btn:disabled { background-color: var(--btn-disabled-bg) !important; color: #9ca3af !important; cursor: not-allowed; box-shadow: none; transform: none; }
        .settings-menu .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 3px 6px rgba(0,0,0,0.08); }
        .settings-menu .btn:active:not(:disabled) { transform: translateY(0px) scale(0.98); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn-create { background-color: var(--btn-action-bg); } .btn-create:hover:not(:disabled) { background-color: var(--btn-action-hover-bg); }
        .btn-rename { background-color: var(--btn-action-bg); } .btn-rename:hover:not(:disabled) { background-color: var(--btn-action-hover-bg); }
        .btn-delete { background-color: var(--btn-delete-bg); } .btn-delete:hover:not(:disabled) { background-color: var(--btn-delete-hover-bg); }
        .btn-download-image { background-color: var(--btn-img-bg); } .btn-download-image:hover:not(:disabled) { background-color: var(--btn-img-hover-bg); }

        /* --- Table Styling --- */
        .table-wrapper { overflow-x: auto; margin-top: 15px; border-radius: 10px; border: 1px solid var(--border-color); }
        .tracker-table { width: 100%; /* Table itself is full width of wrapper */ /* min-width: 750px; /* Can remove if not needed */ border-collapse: collapse; table-layout: fixed; }
        .tracker-table th, .tracker-table td { border-right: none; border-left: none; border-top: none; border-bottom: 1px solid var(--border-color); padding: 12px 15px; vertical-align: middle; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; transition: background-color 0.2s ease; }
        .tracker-table tr:last-child td { border-bottom: none; }
        /* Header Styling */
        .tracker-table thead th { font-weight: 600; color: var(--text-medium); position: sticky; top: 0; z-index: 10; background-color: #fdfdfd; border-bottom: 2px solid var(--border-stronger); text-align: center; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .tracker-table thead th:first-child { text-align: left; background-color: #fcfcfc; color: var(--text-dark); font-weight: 600; text-transform: none; letter-spacing: 0; font-size: 13px; width: 120px; position: sticky; left: 0; z-index: 11; }
        .tracker-table th.name-header { background-color: var(--header-bg-name); color: var(--primary-color); width: 110px; cursor: pointer; transition: background-color 0.2s ease; }
        .tracker-table th.name-header:hover { background-color: var(--primary-light); color: #fff; }
        .tracker-table th.name-header:focus-within { outline: 2px solid var(--primary-color); outline-offset: -1px; background-color: #fff; color: var(--text-dark); overflow: visible; white-space: normal; z-index: 11; box-shadow: 0 0 0 3px var(--primary-lighter); border-radius: 4px; }
        .tracker-table th.add-column-cell { width: 50px; background-color: #f9fafb; padding: 0; vertical-align: middle; border-bottom: 2px solid var(--border-stronger); }
        button#add-column-btn { width: 100%; height: 100%; border: none; background: #e0e7ff; color: var(--primary-color); font-size: 20px; font-weight: bold; cursor: pointer; transition: background-color 0.2s ease; display: flex; align-items: center; justify-content: center; padding: 10px 0; }
        button#add-column-btn:hover { background-color: var(--primary-light); color: #fff; }

        /* Body Cell Styling */
        .tracker-table tbody td { text-align: left; color: var(--text-medium); }
        .tracker-table td:first-child { font-weight: 500; color: var(--text-dark); background-color: #fff; border-right: 1px solid var(--border-color); position: sticky; left: 0; z-index: 1; }
        .tracker-table td.checkbox-cell { text-align: center; width: 70px; padding: 8px; }
        .tracker-table tr td:last-child { background-color: #f9fafb; border-bottom: 1px solid var(--border-color); }
        .tracker-table tr:last-child td:last-child { border-bottom: none; }
        /* Hover */
        .tracker-table tbody tr:hover td { background-color: var(--hover-bg); }
        .tracker-table tbody tr:hover td:first-child { background-color: #fff; }
        .tracker-table tbody tr:hover td:last-child { background-color: #f1f3f5; }

        /* Custom Checkbox */
        .tracker-table input[type="checkbox"] { appearance: none; -webkit-appearance: none; -moz-appearance: none; margin: 0; padding: 0; display: inline-block; vertical-align: middle; position: relative; cursor: pointer; width: 18px; height: 18px; background-color: #fff; border: 2px solid var(--border-stronger); border-radius: 5px; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .tracker-table input[type="checkbox"]:checked { background-color: var(--primary-color); border-color: var(--primary-color); }
        .tracker-table input[type="checkbox"]::after { content: ''; display: block; position: absolute; top: 1px; left: 5px; width: 4px; height: 9px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg) scale(0); opacity: 0; transition: transform 0.2s ease-in-out, opacity 0.2s ease; }
        .tracker-table input[type="checkbox"]:checked::after { transform: rotate(45deg) scale(1); opacity: 1; }
        .tracker-table input[type="checkbox"]:focus-visible { outline: 2px solid var(--primary-light); outline-offset: 2px; }
    </style>
</head>
<body>

<div class="tracker-container" id="tracker-capture-area">
    <div class="header-area">
        <h1 class="tracker-title">Monthly Tracker</h1>
        <div class="settings-icon" id="settings-btn" title="Settings">âš™</div>
    </div>

    <div class="settings-menu" id="settings-options">
        <div class="tracker-select-group">
            <label for="tracker-select">Current:</label>
            <select id="tracker-select"></select>
        </div>
        <div class="action-buttons">
            <button id="create-tracker-btn" class="btn btn-create" title="Create a new blank tracker page">Create New</button>
            <button id="rename-tracker-btn" class="btn btn-rename" title="Rename the current tracker page">Rename</button>
            <button id="delete-tracker-btn" class="btn btn-delete" title="Delete the current tracker page">Delete</button>
            <button id="download-image-btn" class="btn btn-download-image" title="Download the current view as an image">Download Image</button>
        </div>
    </div>

    <div class="table-wrapper" id="table-scroll-wrapper">
        <table class="tracker-table">
            <thead>
                 <tr id="header-row">
                    <th>Month</th>
                    <th id="name-header-1" class="name-header" contenteditable="true" spellcheck="false">Name 1</th>
                    <th id="name-header-2" class="name-header" contenteditable="true" spellcheck="false">Name 2</th>
                    <th id="name-header-3" class="name-header" contenteditable="true" spellcheck="false">Name 3</th>
                    <th id="name-header-4" class="name-header" contenteditable="true" spellcheck="false">Name 4</th>
                    <th id="name-header-5" class="name-header" contenteditable="true" spellcheck="false">Name 5</th>
                    <th class="add-column-cell">
                        <button id="add-column-btn" title="Add Name Column">+</button>
                    </th>
                </tr>
            </thead>
            <tbody id="tracker-body">
                 <!-- Rows Jan-Dec added by JS logic or initial HTML if preferred -->
                  <tr> <td>January</td> <td class="checkbox-cell"><input type="checkbox" id="chk-0-1"></td> <td class="checkbox-cell"><input type="checkbox" id="chk-0-2"></td> <td class="checkbox-cell"><input type="checkbox" id="chk-0-3"></td> <td class="checkbox-cell"><input type="checkbox" id="chk-0-4"></td> <td class="checkbox-cell"><input type="checkbox" id="chk-0-5"></td> <td></td> </tr> <tr><td>February</td><td class="checkbox-cell"><input type="checkbox" id="chk-1-1"></td><td class="checkbox-cell"><input type="checkbox" id="chk-1-2"></td><td class="checkbox-cell"><input type="checkbox" id="chk-1-3"></td><td class="checkbox-cell"><input type="checkbox" id="chk-1-4"></td><td class="checkbox-cell"><input type="checkbox" id="chk-1-5"></td><td></td></tr> <tr><td>March</td><td class="checkbox-cell"><input type="checkbox" id="chk-2-1"></td><td class="checkbox-cell"><input type="checkbox" id="chk-2-2"></td><td class="checkbox-cell"><input type="checkbox" id="chk-2-3"></td><td class="checkbox-cell"><input type="checkbox" id="chk-2-4"></td><td class="checkbox-cell"><input type="checkbox" id="chk-2-5"></td><td></td></tr> <tr><td>April</td><td class="checkbox-cell"><input type="checkbox" id="chk-3-1"></td><td class="checkbox-cell"><input type="checkbox" id="chk-3-2"></td><td class="checkbox-cell"><input type="checkbox" id="chk-3-3"></td><td class="checkbox-cell"><input type="checkbox" id="chk-3-4"></td><td class="checkbox-cell"><input type="checkbox" id="chk-3-5"></td><td></td></tr> <tr><td>May</td><td class="checkbox-cell"><input type="checkbox" id="chk-4-1"></td><td class="checkbox-cell"><input type="checkbox" id="chk-4-2"></td><td class="checkbox-cell"><input type="checkbox" id="chk-4-3"></td><td class="checkbox-cell"><input type="checkbox" id="chk-4-4"></td><td class="checkbox-cell"><input type="checkbox" id="chk-4-5"></td><td></td></tr> <tr><td>June</td><td class="checkbox-cell"><input type="checkbox" id="chk-5-1"></td><td class="checkbox-cell"><input type="checkbox" id="chk-5-2"></td><td class="checkbox-cell"><input type="checkbox" id="chk-5-3"></td><td class="checkbox-cell"><input type="checkbox" id="chk-5-4"></td><td class="checkbox-cell"><input type="checkbox" id="chk-5-5"></td><td></td></tr> <tr><td>July</td><td class="checkbox-cell"><input type="checkbox" id="chk-6-1"></td><td class="checkbox-cell"><input type="checkbox" id="chk-6-2"></td><td class="checkbox-cell"><input type="checkbox" id="chk-6-3"></td><td class="checkbox-cell"><input type="checkbox" id="chk-6-4"></td><td class="checkbox-cell"><input type="checkbox" id="chk-6-5"></td><td></td></tr> <tr><td>August</td><td class="checkbox-cell"><input type="checkbox" id="chk-7-1"></td><td class="checkbox-cell"><input type="checkbox" id="chk-7-2"></td><td class="checkbox-cell"><input type="checkbox" id="chk-7-3"></td><td class="checkbox-cell"><input type="checkbox" id="chk-7-4"></td><td class="checkbox-cell"><input type="checkbox" id="chk-7-5"></td><td></td></tr> <tr><td>September</td><td class="checkbox-cell"><input type="checkbox" id="chk-8-1"></td><td class="checkbox-cell"><input type="checkbox" id="chk-8-2"></td><td class="checkbox-cell"><input type="checkbox" id="chk-8-3"></td><td class="checkbox-cell"><input type="checkbox" id="chk-8-4"></td><td class="checkbox-cell"><input type="checkbox" id="chk-8-5"></td><td></td></tr> <tr><td>October</td><td class="checkbox-cell"><input type="checkbox" id="chk-9-1"></td><td class="checkbox-cell"><input type="checkbox" id="chk-9-2"></td><td class="checkbox-cell"><input type="checkbox" id="chk-9-3"></td><td class="checkbox-cell"><input type="checkbox" id="chk-9-4"></td><td class="checkbox-cell"><input type="checkbox" id="chk-9-5"></td><td></td></tr> <tr><td>November</td><td class="checkbox-cell"><input type="checkbox" id="chk-10-1"></td><td class="checkbox-cell"><input type="checkbox" id="chk-10-2"></td><td class="checkbox-cell"><input type="checkbox" id="chk-10-3"></td><td class="checkbox-cell"><input type="checkbox" id="chk-10-4"></td><td class="checkbox-cell"><input type="checkbox" id="chk-10-5"></td><td></td></tr> <tr><td>December</td><td class="checkbox-cell"><input type="checkbox" id="chk-11-1"></td><td class="checkbox-cell"><input type="checkbox" id="chk-11-2"></td><td class="checkbox-cell"><input type="checkbox" id="chk-11-3"></td><td class="checkbox-cell"><input type="checkbox" id="chk-11-4"></td><td class="checkbox-cell"><input type="checkbox" id="chk-11-5"></td><td></td></tr>
             </tbody>
        </table>
    </div>
</div>

<script>
    // --- FULL JAVASCRIPT (same as the last provided "add column" version) ---
    document.addEventListener('DOMContentLoaded', function() {
        // References
        const settingsBtn = document.getElementById('settings-btn');
        const settingsOptionsDiv = document.getElementById('settings-options');
        const trackerSelect = document.getElementById('tracker-select');
        const createTrackerBtn = document.getElementById('create-tracker-btn');
        const renameTrackerBtn = document.getElementById('rename-tracker-btn');
        const deleteTrackerBtn = document.getElementById('delete-tracker-btn');
        const downloadImageBtn = document.getElementById('download-image-btn');
        const addColumnBtn = document.getElementById('add-column-btn');
        const captureArea = document.getElementById('tracker-capture-area');
        const tableWrapper = document.getElementById('table-scroll-wrapper');
        const pageTitleElement = document.querySelector('h1.tracker-title');
        const theadRow = document.getElementById('header-row');
        const tbody = document.getElementById('tracker-body');

        // Keys & Global State
        const masterListKey = 'myTrackers_list_v1';
        const activeTrackerKeyPreference = 'myTrackers_activeKey_v1';
        let currentTrackerKey = null;

        // Tracker List Management
        function getTrackers() { const listJSON = localStorage.getItem(masterListKey); try { const list = JSON.parse(listJSON); return Array.isArray(list) && list.length > 0 ? list : createDefaultTrackerList(); } catch (e) { return createDefaultTrackerList(); } }
        function saveTrackers(trackerList) { localStorage.setItem(masterListKey, JSON.stringify(trackerList)); populateTrackerSelect(trackerList); }
        function createDefaultTrackerList() { const defaultKey = generateUniqueKey('default_'); const defaultList = [{ key: defaultKey, name: 'My First Tracker', colCount: 5 }]; localStorage.setItem(masterListKey, JSON.stringify(defaultList)); let setAsActive = false; if(!getActiveTrackerKey()) {setActiveTrackerKey(defaultKey); setAsActive = true;} if (!localStorage.getItem(defaultKey)) { saveCurrentStateData({ headers: {}, checks: {}, columnCount: 5 }, defaultKey); } if(setAsActive){currentTrackerKey = defaultKey;} return defaultList; }
        function generateUniqueKey(prefix = 'tracker_') { return prefix + Date.now() + '_' + Math.random().toString(36).substr(2, 5); }
        function getActiveTrackerKey() { return localStorage.getItem(activeTrackerKeyPreference); }
        function setActiveTrackerKey(key) { currentTrackerKey = key; localStorage.setItem(activeTrackerKeyPreference, key); if (trackerSelect) { trackerSelect.value = key; } }

        // State Management
        function getStateDataForKey(trackerKey) { const dataJSON = localStorage.getItem(trackerKey); try { const data = JSON.parse(dataJSON); const defaultData = { headers: {}, checks: {}, columnCount: 5 }; return data && typeof data === 'object' ? { ...defaultData, ...data } : defaultData; } catch (e) { return { headers: {}, checks: {}, columnCount: 5 }; } }
        function saveCurrentStateData(data, trackerKey = currentTrackerKey) { if (!trackerKey) { console.warn("Cannot save state, no tracker key active."); return; } try { data.columnCount = document.querySelectorAll('.tracker-table thead th.name-header').length; localStorage.setItem(trackerKey, JSON.stringify(data)); } catch (error) { console.error("Error saving state for key:", trackerKey, error); } }
        function saveCurrentUIToState() { if (!currentTrackerKey) return; const currentHeaders = document.querySelectorAll('th.name-header[contenteditable="true"]'); const currentCheckboxes = document.querySelectorAll('tbody input[type="checkbox"]'); const currentState = { headers: {}, checks: {}, columnCount: currentHeaders.length }; currentHeaders.forEach(header => { currentState.headers[header.id] = header.textContent.trim(); }); currentCheckboxes.forEach(checkbox => { currentState.checks[checkbox.id] = checkbox.checked; }); saveCurrentStateData(currentState); console.log(`UI State saved for ${currentTrackerKey} with ${currentState.columnCount} columns.`); }

        // Core UI Handlers
        function handleHeaderInput(event) { if (event.key === 'Enter') { event.preventDefault(); event.target.blur(); } }
        function handleHeaderFocus(event) { setTimeout(() => { try { document.execCommand('selectAll', false, null); } catch (e) { console.warn("Select all failed.") } }, 0); }
        function handleHeaderBlur(event) { saveCurrentUIToState(); }
        function handleCheckboxChange(event) { saveCurrentUIToState(); }

        // Add/Remove Columns
        function addColumnToUI(columnIndex) { const newHeaderId = `name-header-${columnIndex}`; const newTh = document.createElement('th'); newTh.id = newHeaderId; newTh.className = 'name-header'; newTh.contentEditable = 'true'; newTh.spellcheck = 'false'; newTh.textContent = `Name ${columnIndex}`; theadRow.insertBefore(newTh, document.querySelector('.add-column-cell')); newTh.addEventListener('keydown', handleHeaderInput); newTh.addEventListener('focus', handleHeaderFocus); newTh.addEventListener('blur', handleHeaderBlur); const rows = tbody.querySelectorAll('tr'); rows.forEach((row, rowIndex) => { const newTd = document.createElement('td'); newTd.className = 'checkbox-cell'; const newCheckbox = document.createElement('input'); newCheckbox.type = 'checkbox'; newCheckbox.id = `chk-${rowIndex}-${columnIndex}`; newCheckbox.addEventListener('change', handleCheckboxChange); newTd.appendChild(newCheckbox); row.insertBefore(newTd, row.lastElementChild); }); console.log(`Added UI for column ${columnIndex}`); }
        function removeExtraColumns(currentColCount, targetColCount) { if (currentColCount <= targetColCount) return; console.log(`Removing ${currentColCount - targetColCount} extra columns.`); for (let i = currentColCount; i > targetColCount; i--) { const headerToRemove = document.getElementById(`name-header-${i}`); if (headerToRemove) headerToRemove.remove(); const cellsToRemove = tbody.querySelectorAll(`td:nth-child(${i + 1})`); cellsToRemove.forEach(cell => cell.remove()); } } // +1 because month is :nth-child(1)
        function setupInitialColumns(savedColumnCount) { const currentColumnCount = document.querySelectorAll('.tracker-table thead th.name-header').length; if (savedColumnCount > currentColumnCount) { for (let i = currentColumnCount + 1; i <= savedColumnCount; i++) { addColumnToUI(i); } } else if (savedColumnCount < currentColumnCount) { removeExtraColumns(currentColumnCount, savedColumnCount); } document.querySelectorAll('th.name-header').forEach(th => { th.removeEventListener('keydown', handleHeaderInput); th.removeEventListener('focus', handleHeaderFocus); th.removeEventListener('blur', handleHeaderBlur); th.addEventListener('keydown', handleHeaderInput); th.addEventListener('focus', handleHeaderFocus); th.addEventListener('blur', handleHeaderBlur); }); document.querySelectorAll('tbody input[type="checkbox"]').forEach(cb => { cb.removeEventListener('change', handleCheckboxChange); cb.addEventListener('change', handleCheckboxChange); }); }

        // Load State
        function loadStateFromKey(trackerKey) { setActiveTrackerKey(trackerKey); const data = getStateDataForKey(trackerKey); const trackers = getTrackers(); const currentTrackerInfo = trackers.find(t => t.key === trackerKey); if (pageTitleElement) { pageTitleElement.textContent = currentTrackerInfo ? currentTrackerInfo.name : "Monthly Tracker"; } setupInitialColumns(data.columnCount || 5); const currentHeaders = document.querySelectorAll('th.name-header[contenteditable="true"]'); const currentCheckboxes = document.querySelectorAll('tbody input[type="checkbox"]'); currentHeaders.forEach(header => { header.textContent = data.headers?.[header.id] || `Name ${header.id.split('-')[2]}`; }); currentCheckboxes.forEach(checkbox => { checkbox.checked = data.checks?.[checkbox.id] || false; }); console.log(`State loaded for ${currentTrackerInfo ? currentTrackerInfo.name : trackerKey}`); const canDelete = trackers.length > 1; if(deleteTrackerBtn) { deleteTrackerBtn.disabled = !canDelete; deleteTrackerBtn.title = canDelete ? "Delete" : "Cannot delete"; } if(renameTrackerBtn) { renameTrackerBtn.disabled = false; renameTrackerBtn.title = "Rename"; } }
        // Reset UI
        function resetUIToDefault(newTrackerName = "New Tracker") { const defaultCols = 5; removeExtraColumns(document.querySelectorAll('.tracker-table thead th.name-header').length, defaultCols); const currentHeaders = document.querySelectorAll('th.name-header[contenteditable="true"]'); const currentCheckboxes = document.querySelectorAll('tbody input[type="checkbox"]'); currentHeaders.forEach(header => { header.textContent = `Name ${header.id.split('-')[2]}`; }); currentCheckboxes.forEach(checkbox => { checkbox.checked = false; }); if(pageTitleElement) { pageTitleElement.textContent = newTrackerName; } }

        // Populate Dropdown
        function populateTrackerSelect(trackerList) { trackerSelect.innerHTML = ''; let activeKeyExistsInList = false; if (!Array.isArray(trackerList)) { trackerList = createDefaultTrackerList(); } trackerList.forEach(tracker => { if(typeof tracker !== 'object' || !tracker.key || !tracker.name) return; const option = document.createElement('option'); option.value = tracker.key; option.textContent = tracker.name; trackerSelect.appendChild(option); if(tracker.key === currentTrackerKey) activeKeyExistsInList = true; }); if(activeKeyExistsInList) { trackerSelect.value = currentTrackerKey; } else if (trackerList.length > 0) { setActiveTrackerKey(trackerList[0].key); trackerSelect.value = currentTrackerKey; } else { const defaultList = createDefaultTrackerList(); populateTrackerSelect(defaultList); } }

        // Download Image
        function downloadTrackerAsImage() { if (typeof html2canvas === 'undefined') { alert("Error: html2canvas library not loaded."); return; } console.log("Starting image capture..."); const originalWrapperOverflow = tableWrapper.style.overflow; const originalWrapperHeight = tableWrapper.style.height; const originalContainerHeight = captureArea.style.height; const settingsWasOpen = settingsOptionsDiv.classList.contains('open'); settingsOptionsDiv.classList.remove('open'); settingsOptionsDiv.style.display = 'none'; tableWrapper.style.overflow = 'visible'; tableWrapper.style.height = 'auto'; captureArea.style.height = 'auto'; captureArea.style.paddingBottom = '30px'; new Promise(resolve => setTimeout(resolve, 150)).then(() => { html2canvas(captureArea, { allowTaint: true, useCORS: true, backgroundColor: getComputedStyle(document.body).backgroundColor || '#f5f3ff', scale: 1.5 }).then(canvas => { const imageDataUrl = canvas.toDataURL('image/png'); const a = document.createElement('a'); a.href = imageDataUrl; const date = new Date(); const timestamp = `${date.getFullYear()}${(date.getMonth() + 1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`; const currentTrackerName = getTrackers().find(t => t.key === currentTrackerKey)?.name || 'tracker'; const safeName = currentTrackerName.replace(/[^a-z0-9]/gi, '_').toLowerCase(); a.download = `${safeName}_${timestamp}.png`; document.body.appendChild(a); a.click(); document.body.removeChild(a); console.log("Image download initiated."); }).catch(error => { console.error("Error capturing image:", error); alert("Sorry, there was an error generating the image."); }).finally(() => { console.log("Restoring original styles..."); tableWrapper.style.overflow = originalWrapperOverflow; tableWrapper.style.height = originalWrapperHeight; captureArea.style.height = originalContainerHeight; captureArea.style.paddingBottom = ''; if(settingsWasOpen) { settingsOptionsDiv.style.display = 'flex'; void settingsOptionsDiv.offsetWidth; settingsOptionsDiv.classList.add('open'); } else { settingsOptionsDiv.style.display = 'none'; } }); }); }

        // Event Listeners
        settingsBtn.addEventListener('click', function() { const isOpen = settingsOptionsDiv.classList.contains('open'); if (!isOpen) { settingsOptionsDiv.style.display = 'flex'; void settingsOptionsDiv.offsetWidth; settingsOptionsDiv.classList.add('open'); } else { settingsOptionsDiv.classList.remove('open'); } settingsBtn.classList.toggle('active'); });
        trackerSelect.addEventListener('change', function() { const selectedKey = trackerSelect.value; if(selectedKey && selectedKey !== currentTrackerKey) { loadStateFromKey(selectedKey); } });
        createTrackerBtn.addEventListener('click', function() { const currentTrackers = getTrackers(); const newName = prompt("Enter name:", "Tracker " + (currentTrackers.length + 1)); if (newName && newName.trim() !== '') { const newKey = generateUniqueKey(); const defaultCols = 5; currentTrackers.push({ key: newKey, name: newName.trim(), colCount: defaultCols}); saveTrackers(currentTrackers); resetUIToDefault(newName.trim()); setActiveTrackerKey(newKey); saveCurrentStateData({ headers: {}, checks: {}, columnCount: defaultCols }, newKey); loadStateFromKey(newKey); trackerSelect.value = newKey; alert(`Tracker "${newName.trim()}" created!`); } else if (newName !== null) { alert("Name cannot be empty."); } });
        renameTrackerBtn.addEventListener('click', function() { if (!currentTrackerKey || renameTrackerBtn.disabled) return; const currentTrackers = getTrackers(); const currentTracker = currentTrackers.find(t => t.key === currentTrackerKey); if (!currentTracker) return; const newName = prompt("New name:", currentTracker.name); if (newName && newName.trim() !== '') { currentTracker.name = newName.trim(); saveTrackers(currentTrackers); if (pageTitleElement) { pageTitleElement.textContent = newName.trim();} alert(`Renamed to "${newName.trim()}"!`); } else if (newName !== null) { alert("Name cannot be empty."); } });
        deleteTrackerBtn.addEventListener('click', function() { if (!currentTrackerKey || deleteTrackerBtn.disabled) return; const currentTrackers = getTrackers(); const currentTracker = currentTrackers.find(t => t.key === currentTrackerKey); if (!currentTracker) return; if (confirm(`DELETE "${currentTracker.name}"?`)) { localStorage.removeItem(currentTrackerKey); const updatedTrackers = currentTrackers.filter(t => t.key !== currentTrackerKey); saveTrackers(updatedTrackers); const newActiveKey = updatedTrackers[0]?.key; if(newActiveKey) { loadStateFromKey(newActiveKey); } else { initializeApp(); } } });
        downloadImageBtn.addEventListener('click', downloadTrackerAsImage);
        addColumnBtn.addEventListener('click', function() { const currentHeaders = document.querySelectorAll('.tracker-table thead th.name-header'); const newColumnIndex = currentHeaders.length + 1; addColumnToUI(newColumnIndex); saveCurrentUIToState(); });

        // Initial App Load
        function initializeApp() { console.log("Initializing App (v_add_column_fullwidth)..."); let keyToLoad = getActiveTrackerKey(); const trackers = getTrackers(); if (!keyToLoad || !trackers.some(t => t.key === keyToLoad)) { keyToLoad = trackers[0]?.key; } if (keyToLoad) setActiveTrackerKey(keyToLoad); else console.error("CRITICAL: No tracker key found!"); populateTrackerSelect(trackers); if (currentTrackerKey) { loadStateFromKey(currentTrackerKey); } else { /* Error Handling */ if(pageTitleElement) pageTitleElement.textContent = "Error"; } settingsOptionsDiv.classList.remove('open'); settingsOptionsDiv.style.display = 'none'; }
        initializeApp();

    });
</script>

</body>
</html>
